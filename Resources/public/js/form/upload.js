define(["jquery","jquery/fileupload","jquery/qtip","ekyna-form/file-picker","ekyna-string"],function(a){"use strict";function b(b,c){b.data("RenameWidget",this),c=a.extend({file:null},c),this.$element=b,this.$file=c.file,this.extension="",this.defaultValue=this.$element.val(),this.getExtension(),this.$file&&1===this.$file.length&&(this.$file.on("change",a.proxy(this.updateFromFile,this)),this.updateFromFile()),this.$element.on("focus",a.proxy(this.stripExtension,this)),this.$element.on("blur",a.proxy(this.normalize,this))}function c(a){a.data("UploadWidget",this),this.$element=a,this.$picker=this.$element.find(".file-picker"),this.$file=this.$picker.find("input:file"),this.$element.find(".file-rename").renameWidget({file:this.$file}),this.$key=this.$element.find('input[data-target="'+this.$file.attr("id")+'"]'),0!==this.$key.length&&(this.$form=this.$file.closest("form"),this.$progressBar=this.$element.find("div#"+this.$file.attr("id")+"_progress"),this.$submitButton=this.$form.find("[type=submit]"),this.uploadXhr=null,this.init())}return b.prototype.getExtension=function(){var a=this.$element.val().fileExtension();a.length>0&&(this.extension="."+a),this.normalize()},b.prototype.stripExtension=function(){if(0!==this.extension.length){var a=this.$element.val().lastIndexOf(this.extension);0<a&&this.$element.val(this.$element.val().substring(0,a))}},b.prototype.appendExtension=function(){this.$element.val(this.$element.val()+this.extension)},b.prototype.normalize=function(){this.stripExtension();var a=this.$element.val().trim().toLowerCase().urlize();0<a.length?(this.$element.val(a),this.appendExtension()):this.$element.val(this.defaultValue)},b.prototype.updateFromFile=function(){if(0!==this.$file.length){var a=this.$file.val();if(0<a.length){0===this.$element.val().length&&this.$element.val(a.fileName());var b=a.fileName().fileExtension();b.length>0?(this.stripExtension(),this.extension="."+b,this.normalize()):this.getExtension()}else this.$element.val(this.defaultValue),this.getExtension()}},a.fn.renameWidget=function(c){return this.each(function(){void 0===a(this).data("RenameWidget")&&new b(a(this),c)}),this},c.prototype.init=function(){this.$file.fileupload({replaceFileInput:!1}),this.$file.on("fileuploadadd",a.proxy(this.onUploadAdd,this)),this.$file.on("fileuploadsubmit",a.proxy(this.onUploadSubmit,this)),this.$file.on("fileuploadalways",a.proxy(this.onUploadAlways,this)),this.$file.on("fileuploaddone",a.proxy(this.onUploadDone,this)),this.$file.on("fileuploadprogress",a.proxy(this.onUploadProgress,this)),this.$picker.on("ekyna.upload.clear",a.proxy(this.onPickerClear,this)),this.$form.on("submit",a.proxy(this.onFormSubmit,this))},c.prototype.onUploadAdd=function(a,b){this.uploadXhr&&this.uploadXhr.abort(),this.uploadXhr=b.submit()},c.prototype.onUploadSubmit=function(){var a=this.$form.data("uploadCount")||0;a++,this.$submitButton.prop("disabled",!0),this.$form.data("uploadCount",a),this.$progressBar.fadeIn()},c.prototype.onUploadAlways=function(){var b=this.$form.data("uploadCount")||0;b--,this.$form.data("uploadCount",b),0>=b&&this.$submitButton.prop("disabled",!1),this.$progressBar.fadeOut(function(){a(this).find(".progress-bar").css({width:"0%"}).attr("aria-valuenow",0)}),this.uploadXhr=null},c.prototype.onUploadDone=function(a,b){var c=JSON.parse(b.result);c.hasOwnProperty("upload_key")&&this.$key.val(c.upload_key)},c.prototype.onUploadProgress=function(a,b){if(b._progress){var c=parseInt(b._progress.loaded/b._progress.total*100,10);this.$progressBar.find(".progress-bar").css({width:c+"%"}).attr("aria-valuenow",c)}},c.prototype.onPickerClear=function(){this.$key.val(null),this.uploadXhr&&(this.uploadXhr.abort(),this.uploadXhr=null)},c.prototype.onFormSubmit=function(a){var b=this.$form.data("uploadCount")||0;return 0>=b||(this.$submitButton.qtip({content:"Veuillez patienter pendant le téléchargement de vos fichiers&hellip;",style:{classes:"qtip-bootstrap"},hide:{fixed:!0,delay:300},position:{my:"bottom center",at:"top center",target:"mouse",adjust:{mouse:!1,scroll:!1}}}),a.preventDefault(),!1)},a.fn.uploadWidget=function(){return this.each(function(){void 0===a(this).data("UploadWidget")&&new c(a(this))}),this},{init:function(a){a.uploadWidget()}}});