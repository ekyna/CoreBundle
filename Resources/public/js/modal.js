define(["require","jquery","bootstrap/dialog"],function(a,b,c){"use strict";var d="button[data-modal], a[data-modal], [data-modal] > a",e=function(){this.dialog=new c,this.form=null,this.shown=!1;var a=this,e=b(this);this.dialog.onShow(function(){var c=b.Event("ekyna.modal.show");c.modal=a,e.trigger(c),a.dialog.getModalBody().on("click",d,function(c){return c.preventDefault(),c.stopPropagation(),a.load({url:b(c.currentTarget).attr("href")}),!1})}),this.dialog.onShown(function(){a.shown=!0;var c=b.Event("ekyna.modal.shown");c.modal=a,e.trigger(c)}),this.dialog.onHide(function(){a.shown=!1;var c=b.Event("ekyna.modal.hide");return c.modal=a,e.trigger(c),!c.isDefaultPrevented()&&void(a.form&&(a.form.destroy(),a.form=null))}),this.dialog.onHidden(function(){var c=b.Event("ekyna.modal.hidden");c.modal=a,e.trigger(c)})};return e.prototype={constructor:e,load:function(a){a.cache=!1;var c=this,d=b.ajax(a);return d.done(function(a,b,d){c.handleResponse(a,b,d)}),d.fail(function(){console.log("Failed to load modal.");var a=b.Event("ekyna.modal.load_fail");b(c).trigger(a)}),d},initForm:function(c){var d=this;b(this.dialog.getModal()).removeAttr("tabindex"),a(["ekyna-form"],function(a){d.form=a.create(c),d.form.init(d.dialog.getModal()),d.form.getElement().on("submit",function(a){a.preventDefault(),d.dialog.enableButtons(!1);var b=d.dialog.getButton("submit");return b&&b.spin(),d.form.save(),setTimeout(function(){d.form.getElement().ajaxSubmit({success:function(a,b,c){d.handleResponse(a,b,c)}})},100),!1})})},getContentType:function(a){var b="html",c=a.getResponseHeader("content-type");return/json/.test(c)?b="json":/xml/.test(c)&&(b="xml"),b},handleResponse:function(a,c,d){var e,f=this,g=b(this),h=this.getContentType(d);if(this.form&&(this.form.destroy(),this.form=null),e=b.Event("ekyna.modal.response"),e.modal=this,e.contentType=h,e.content=a,e.jqXHR=d,g.trigger(e),e.isDefaultPrevented())return this;if("xml"!==h)return this;var i=b(a),j=i.find("content");if(!(j.length>0))return this;h=j.attr("type"),e=b.Event("ekyna.modal.content"),e.modal=this,e.contentType=h;var k=j.text();if("data"===h)return e.content=JSON.parse(k),g.trigger(e),e.isDefaultPrevented()?this:e.content.load_url?(this.load({url:e.content.load_url,method:"GET"}),this):e.content.redirect_url?(window.location.href=e.content.redirect_url,this):this.close();var l=b(k);if(e.content=l,g.trigger(e),e.isDefaultPrevented())return this.close();this.dialog.setMessage(l),"form"===h&&l.each(function(){var a=b(this);a.is("form")&&(f.shown?f.initForm(a):g.one("ekyna.modal.shown",function(){f.initForm(a)}))});var m=i.find("title");1===m.length&&this.dialog.setTitle(m.text());var n=i.find("buttons");if(1===n.length){var o=JSON.parse(n.text(),function(a,b){return b&&"string"==typeof b&&0===b.indexOf("function")?new Function("return "+b)():b});b(o).each(function(a,c){"function"!=typeof c.action&&("close"===c.id?c.action=function(a){a.enableButtons(!1),a.close()}:c.action=function(a){a.enableButtons(!1);var d=b.Event("ekyna.modal.button_click");d.modal=f,d.buttonId=c.id,g.trigger(d),f.form&&"submit"===c.id&&!d.isDefaultPrevented()&&f.form.getElement().submit()})}),this.dialog.setButtons(o)}else this.dialog.setButtons([]);var p=JSON.parse(i.find("config").text());return"undefined"!=typeof p.type&&this.dialog.setType(p.type),"undefined"!=typeof p.size&&this.dialog.setSize(p.size),"undefined"!=typeof p.cssClass&&this.dialog.setCssClass(p.cssClass),this.dialog.isOpened()||this.dialog.open(),"undefined"!=typeof p.condensed&&(p.condensed?this.dialog.getModal().addClass("condensed"):this.dialog.getModal().removeClass("condensed")),this},close:function(){return this.dialog.isOpened()&&this.dialog.close(),this},getDialog:function(){return this.dialog}},b(document).on("click",d,function(a){a.preventDefault();var c=new e;return c.load({url:b(a.currentTarget).attr("href")}),!1}),e});