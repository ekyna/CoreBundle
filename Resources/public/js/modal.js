define(["require","jquery","bootstrap/dialog"],function(a,b,c){"use strict";var d=function(){this.dialog=new c,this.form=null,this.shown=!1;var a=this;a.dialog.onShow(function(){var c=b.Event("ekyna.modal.show");c.modal=a,b(a).trigger(c),a.dialog.getModalBody().on("click","button[data-modal], a[data-modal], [data-modal] > a",function(c){return c.preventDefault(),a.load({url:b(c.currentTarget).attr("href")}),!1})}),a.dialog.onShown(function(){a.shown=!0;var c=b.Event("ekyna.modal.shown");c.modal=a,b(a).trigger(c)}),a.dialog.onHide(function(){a.shown=!1;var c=b.Event("ekyna.modal.hide");return c.modal=a,b(a).trigger(c),!c.isDefaultPrevented()&&void(a.form&&(a.form.destroy(),a.form=null))}),a.dialog.onHidden(function(){var c=b.Event("ekyna.modal.hidden");c.modal=a,b(a).trigger(c)})};return d.prototype={constructor:d,load:function(a){a.cache=!1;var c=this,d=b.ajax(a);return d.done(function(a,b,d){c.handleResponse(a,b,d)}),d.fail(function(){console.log("Failed to load modal.");var a=b.Event("ekyna.modal.load_fail");b(c).trigger(a)}),d},initForm:function(c){var d=this;b(d.dialog.getModal()).removeAttr("tabindex"),a(["ekyna-form"],function(a){d.form=a.create(c),d.form.init(d.dialog.getModal()),d.form.getElement().on("submit",function(a){a.preventDefault(),d.dialog.enableButtons(!1);var b=d.dialog.getButton("submit");return b&&b.spin(),d.form.save(),setTimeout(function(){d.form.getElement().ajaxSubmit({success:function(a,b,c){d.handleResponse(a,b,c)}})},100),!1})})},getContentType:function(a){var b="html",c=a.getResponseHeader("content-type");return/json/.test(c)?b="json":/xml/.test(c)&&(b="xml"),b},handleResponse:function(a,c,d){var e,f=this,g=this.getContentType(d);if(f.form&&(f.form.destroy(),f.form=null),e=b.Event("ekyna.modal.response"),e.modal=f,e.contentType=g,e.content=a,e.jqXHR=d,b(f).trigger(e),e.isDefaultPrevented())return f;if("xml"!==g)return this;var h=b(a),i=h.find("content");if(!(i.length>0))return this;g=i.attr("type"),e=b.Event("ekyna.modal.content"),e.modal=f,e.contentType=g;var j=i.text();if("data"===g)return e.content=JSON.parse(j),b(f).trigger(e),f.close();var k=b(j);if(e.content=k,b(f).trigger(e),e.isDefaultPrevented())return f.close();f.dialog.setMessage(k),"form"===g&&k.each(function(){var a=b(this);a.is("form")&&(f.shown?f.initForm(a):b(f).one("ekyna.modal.shown",function(){f.initForm(a)}))});var l=h.find("title");1===l.length&&f.dialog.setTitle(l.text());var m=h.find("buttons");if(1===m.length){var n=JSON.parse(m.text(),function(a,b){return b&&"string"==typeof b&&0===b.indexOf("function")?new Function("return "+b)():b});b(n).each(function(a,c){"function"!=typeof c.action&&("close"===c.id?c.action=function(a){a.enableButtons(!1),a.close()}:c.action=function(a){a.enableButtons(!1);var d=b.Event("ekyna.modal.button_click");d.modal=f,d.buttonId=c.id,b(f).trigger(d),f.form&&"submit"===c.id&&!d.isDefaultPrevented()&&f.form.getElement().submit()})}),f.dialog.setButtons(n)}else f.dialog.setButtons([]);var o=JSON.parse(h.find("config").text());return"undefined"!=typeof o.type&&f.dialog.setType(o.type),"undefined"!=typeof o.size&&f.dialog.setSize(o.size),"undefined"!=typeof o.cssClass&&f.dialog.setCssClass(o.cssClass),f.dialog.isOpened()||f.dialog.open(),"undefined"!=typeof o.condensed&&(o.condensed?f.dialog.getModal().addClass("condensed"):f.dialog.getModal().removeClass("condensed")),this},close:function(){return this.dialog.isOpened()&&this.dialog.close(),this},getDialog:function(){return this.dialog}},b(document).on("click","button[data-modal], a[data-modal], [data-modal] > a",function(a){a.preventDefault();var c=new d;return c.load({url:b(a.currentTarget).attr("href")}),!1}),d});