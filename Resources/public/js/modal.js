define(["require","jquery","bootstrap/dialog","ekyna-polyfill"],function(a,b,c){"use strict";var d="button[data-modal], a[data-modal], [data-modal] > a",e=function(){this.dialog=new c,this.form=null,this.shown=!1;var a=this,e=b(this);this.dialog.onShow(function(){var c=b.Event("ekyna.modal.show");c.modal=a,e.trigger(c),a.dialog.getModalBody().on("click",d,function(c){return c.preventDefault(),c.stopPropagation(),a.load({url:b(c.currentTarget).attr("href")}),!1})}),this.dialog.onShown(function(){a.shown=!0;var c=b.Event("ekyna.modal.shown");c.modal=a,e.trigger(c)}),this.dialog.onHide(function(){a.shown=!1;var c=b.Event("ekyna.modal.hide");return c.modal=a,e.trigger(c),!c.isDefaultPrevented()&&void(a.form&&(a.form.destroy(),a.form=null))}),this.dialog.onHidden(function(){var c=b.Event("ekyna.modal.hidden");c.modal=a,e.trigger(c)})};return e.prototype={constructor:e,load:function(a){a.cache=!1;var c=this,d=b.ajax(a);return d.done(function(a,b,d){c.handleResponse(a,b,d)}),d.fail(function(){console.log("Failed to load modal.");var a=b.Event("ekyna.modal.load_fail");b(c).trigger(a)}),d},initForm:function(c){var d=this;b(this.dialog.getModal()).removeAttr("tabindex"),a(["ekyna-form"],function(a){d.form=a.create(c),d.form.init(d.dialog.getModal());var e=function(a){var b=d.form.getElement().get(0);if((!b.reportValidity||b.reportValidity())&&(!b.hasOwnProperty("_submitted")||!b._submitted)){b._submitted=!0;var c=d.form.getElement(),e={};if(d.dialog.enableButtons(!1),a=a||c.find("button[type=submit]").eq(0),1===a.length)a.find("span, i").removeClass().addClass("glyphicon glyphicon-asterisk icon-spin"),a.attr("name")&&a.attr("value")&&(e[a.attr("name")]=a.attr("value"));else{var f=d.dialog.getButton("submit");f&&f.toggleSpin(!0)}c.find("button").prop("disabled",!0),d.form.save(),setTimeout(function(){d.form.getElement().ajaxSubmit({data:e,success:function(a,b,c){d.handleResponse(a,b,c)},error:function(){b._submitted=!1}})},100)}};d.form.getElement().on("keyup","input, select",function(a){if(13===(a.keyCode?a.keyCode:a.which))return a.preventDefault(),a.stopPropagation(),e(),!1}).on("mouseup","button[type=submit]",function(a){return a.preventDefault(),a.stopPropagation(),e(b(a.target)),!1}).on("submit",function(a){return a.preventDefault(),a.stopPropagation(),e(),!1})})},getContentType:function(a){var b="html",c=a.getResponseHeader("content-type");return/json/.test(c)?b="json":/xml/.test(c)&&(b="xml"),b},handleResponse:function(a,c,d){function e(a){return a.hasOwnProperty("load_url")&&a.load_url?(g.load({url:a.load_url,method:"GET"}),!0):!(!a.hasOwnProperty("redirect_url")||!a.redirect_url)&&(window.location.href=a.redirect_url,!0)}var f,g=this,h=b(this),i=this.getContentType(d);if(this.submitButton=null,this.form&&(this.form.destroy(),this.form=null),f=b.Event("ekyna.modal.response"),f.modal=this,f.contentType=i,f.content=a,f.jqXHR=d,h.trigger(f),f.isDefaultPrevented())return this;if("json"===i&&e(f.content))return this;if("xml"!==i)return this;var j=b(a),k=j.find("content");if(!(k.length>0))return this;i=k.attr("type"),f=b.Event("ekyna.modal.content"),f.modal=this,f.contentType=i;var l=k.text();if("data"===i)return f.content=JSON.parse(l),h.trigger(f),f.isDefaultPrevented()?this:e(f.content)?this:this.close();var m=b(l);if(f.content=m,h.trigger(f),f.isDefaultPrevented())return this.close();this.dialog.setMessage(m),"form"===i&&m.each(function(){var a=b(this);a.is("form")&&(g.shown?g.initForm(a):h.one("ekyna.modal.shown",function(){g.initForm(a)}))}),h.trigger(b.Event("ekyna.modal.updated"));var n=j.find("title");1===n.length&&this.dialog.setTitle(n.text());var o=j.find("buttons");if(1===o.length){var p=JSON.parse(o.text(),function(a,b){return b&&"string"==typeof b&&0===b.indexOf("function")?new Function("return "+b)():b});b(p).each(function(a,c){"function"!=typeof c.action&&("close"===c.id?c.action=function(a){a.enableButtons(!1),a.close()}:c.action=function(a){var d=b.Event("ekyna.modal.button_click");if(d.modal=g,d.buttonId=c.id,h.trigger(d),!d.isDefaultPrevented()&&"submit"===c.id)return g.form?void g.form.getElement().trigger("submit"):void a.enableButtons(!1)})}),this.dialog.setButtons(p)}else this.dialog.setButtons([]);var q=JSON.parse(j.find("config").text());return"undefined"!=typeof q.type&&this.dialog.setType(q.type),"undefined"!=typeof q.size&&this.dialog.setSize(q.size),"undefined"!=typeof q.cssClass&&this.dialog.setCssClass(q.cssClass),this.dialog.isOpened()||this.dialog.open(),"undefined"!=typeof q.condensed&&(q.condensed?this.dialog.getModal().addClass("condensed"):this.dialog.getModal().removeClass("condensed")),this},close:function(){return this.dialog.isOpened()&&this.dialog.close(),this},getDialog:function(){return this.dialog}},b(document).on("click",d,function(a){a.preventDefault();var c=new e;return c.load({url:b(a.currentTarget).attr("href")}),!1}),e});